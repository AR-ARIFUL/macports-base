package require tcltest 2
namespace import tcltest::*

set pwd [file normalize $argv0]
set pwd [eval file join {*}[lrange [file split $pwd] 0 end-1]]

source ../port_test_autoconf.tcl
source $macports::autoconf::macports_tcl_dir/macports1.0/macports_fastload.tcl
package require macports 1.0

array set ui_options {}
#set ui_options(ports_debug)   yes
#set ui_options(ports_verbose) yes
mportinit ui_options

source ./library.tcl
macports_worker_init

source ../portinstall.tcl
source ../../registry2.0/portuninstall.tcl
source ../port_autoconf.tcl

proc run_destroot {} {
    global pwd os_platform os_version os_arch

    set os_platform darwin
    set os.platform darwin
    set macosx_version 10.8
    set os_version 11
    set os_arch i386
    set os.major 10
    set supported_archs {}
    set configure.build_arch build_arch
    set portarchivetype tgz

    set subport fondu
    set version 3.0

    set portpath $pwd
    set portdbpath $pwd/dbpath
    set portbuildpath $pwd
    set destpath $pwd/work/destroot


    # destroot setup
    file mkdir $pwd/$subport
    file copy -force $pwd/Portfile /tmp/
    set mport [mportopen file://.]

    proc getportbuildpath {id {portname ""}} {
        global portdbpath
        regsub {://} $id {.} port_path
        regsub -all {/} $port_path {_} port_path
        return [file join $portdbpath build $port_path $portname]
    }

    proc getportworkpath_from_buildpath {portbuildpath} {
        return [file join $portbuildpath work]
    }

    proc getportworkpath_from_portdir {portpath {portname ""}} {
        return [getportworkpath_from_buildpath [getportbuildpath $portpath tname]]
    }

    source $pwd/../portmain.tcl

    # sets up PortInfo array
    if {[eval_variants variations] != 0} {
        mportclose $mport
        error "Error evaluating variants"
    }

    # set $version var
    set workername [ditem_key $mport workername]

    # run destroot
    $workername eval eval_targets destroot
}


# test uninstall_start


test uninstall_main {
    Uninstall main unit test.
} -constraints {
	root

} -setup {
    set os.platform darwin
    set macosx_version 10.8
    set os_version 11
    set os_arch i386
    set os.major 10
    set supported_archs {}
    set configure.build_arch build_arch
    set portarchivetype tgz

    set subport fondu
    set version 4.0

    set portpath $pwd
    set portdbpath $pwd/dbpath
    set portbuildpath $pwd
    set destpath $pwd/work/destroot

    run_destroot

    # portinstall setup
    interp alias {} _cd {} cd
    set macosx_deployment_target $pwd/deploy_target
    file link -symbolic $pwd/$subport/work $pwd/work

    if {[portinstall::install_main] != 0} {
		return "FAIL: cannot install port"
    }

} -body {
    if {[uninstall_main] != 0} {
		return "FAIL: cannot uninstall port"
    }
    return "Uninstall main successful."

} -cleanup {
    file delete -force $pwd/$subport
    file delete -force $portdbpath
    file delete -force $pwd/work

} -result "Uninstall main successful."


cleanupTests
