#!/usr/bin/env tclsh
# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
#
# Generate a github group template Portfile given tarball URL
#

proc usage {{channel stderr}} {
    global argv0
    puts $channel "Usage: $argv0 URL"
    puts $channel ""
    puts $channel "URL is the github tarball URL"
    puts $channel ""
    puts $channel "Example:"
    puts $channel "  $argv0 https://github.com/tmux/tmux/releases/download/2.0/tmux-2.0.tar.gz"
    puts $channel "  $argv0 https://github.com/jonas/tig/archive/tig-2.1.1.tar.gz"
}

if {$argc != 1} {
    usage
    exit 1
}

set url [lindex $argv 0]

set author author
set project project
set version 1.0
set tag_prefix "";              # tag_prefix, usually is empty or "v"

set tarball_from "";            # tarball type, including release and others

# 2.0, v0.3.8, release-v1.5.8, v0.8.5.tar.gz => version and tag_prefix if has
proc parse_fancy_version {v} {
    global version
    global tag_prefix
    if {[regexp {[0-9]+([.-][0-9]+)+} $v version]} {
        if {[string length $version] < [string length $v]} {
            set tag_prefix [string range $v 0 [expr [string first $version $v] -1]]
        }
    }
}

if {[string match */releases/download/* $url]} {
    set tarball_from releases

    set tmp [split $url /]
    set author [lindex $tmp 3]
    set project [lindex $tmp 4]
    # 2.0, v0.3.0
    set github_version [lindex $tmp 7]
    parse_fancy_version $github_version
} elseif {[string match */archive/* $url]} {
    set tarball_from ""

    set tmp [split $url /]
    set author [lindex $tmp 3]
    set project [lindex $tmp 4]
    # v0.8.5.tar.gz
    set tarball [lindex $tmp 6]
    parse_fancy_version $tarball
} else {
    usage
    exit 1
}

set description replaceme
set homepage ""

set json "/tmp/${author}-${project}.json"
set api "https://api.github.com/repos/${author}/${project}"
exec curl --silent --max-time 5 --output $json $api

# Question: Is it possible to change the value of passed variable?
proc parse_json {query} {
    global json
    set tmp [exec jq $query $json]
    set tmp [string range $tmp 1 [expr [string length $tmp] - 2]]

    puts $tmp

    if {[expr {[string length $tmp] > 0}]} {
        return $tmp
    } else {
        return ""
    }
}

set tmp [parse_json .description]
if {[expr {[string length $tmp] > 0}]} {
    set description $tmp
}

set tmp [parse_json .homepage]
if {[expr {[string length $tmp] > 0}]} {
    set homepage $tmp
}

puts "# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4"
puts "# \$Id\$"
puts ""
puts "PortSystem          1.0"

puts "PortGroup           github 1.0"
puts ""
puts "github.setup        ${author} ${project} ${version} ${tag_prefix}"

# TODO: 6. (optional) Query categories, license etc from other Package Manager
puts "categories          replaceme"
puts "platforms           darwin"

# TODO: 5. (optional) Support environment variable like MaintainerHandle, use USER as fallback
puts "maintainers         replaceme"

if {![string equal $homepage ""]} {
    puts "homepage            $homepage"
}

puts "license             replaceme"

puts ""
puts "description         $description"
puts "long_description    replaceme"
puts ""

if {![string equal $tarball_from ""]} {
    puts "github.tarball_from releases"
}

puts ""
puts "checksums           rmd160  12345 \\"
puts "                    sha256  6789a"
